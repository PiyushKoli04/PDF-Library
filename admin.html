<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel â€” Syntax Archives</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="assets/css/style.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="assets/js/firebase-config.js"></script>
  <script src="assets/js/auth.js" defer></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body { overflow-x: hidden; }
    .container {
      width: 100% !important;
      max-width: 1200px !important;
      padding-left: clamp(16px, 5vw, 40px) !important;
      padding-right: clamp(16px, 5vw, 40px) !important;
      margin: 0 auto !important;
      box-sizing: border-box !important;
    }

    /* â”€â”€ Tab Navigation â”€â”€ */
    .admin-tabs {
      display: flex;
      gap: 4px;
      background: var(--clr-surface);
      border: 1px solid var(--clr-border);
      border-radius: var(--radius-lg);
      padding: 6px;
      margin-bottom: 32px;
      width: fit-content;
      flex-wrap: wrap;
    }
    .admin-tab {
      padding: 9px 20px;
      border-radius: var(--radius-md);
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--clr-text-muted);
      cursor: pointer;
      border: none;
      background: none;
      font-family: var(--font-body);
      transition: background var(--t-fast), color var(--t-fast);
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    .admin-tab:hover { color: var(--clr-text); }
    .admin-tab.active {
      background: var(--clr-surface-2);
      color: var(--clr-text);
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
    .admin-tab .tab-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 5px;
      border-radius: 100px;
      font-size: 0.7rem;
      font-weight: 700;
      background: rgba(76,175,128,0.15);
      color: var(--clr-success);
    }
    .admin-tab .tab-badge.has-unread {
      background: rgba(200, 80, 80, 0.15);
      color: #e05c5c;
    }

    /* â”€â”€ Tab panels â”€â”€ */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* â”€â”€ Messages Inbox â”€â”€ */
    .messages-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .messages-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .filter-btn {
      padding: 6px 14px;
      border-radius: 100px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid var(--clr-border);
      background: none;
      color: var(--clr-text-muted);
      font-family: var(--font-body);
      transition: all var(--t-fast);
    }
    .filter-btn:hover, .filter-btn.active {
      border-color: var(--clr-success);
      color: var(--clr-success);
      background: rgba(76,175,128,0.08);
    }
    .btn-refresh {
      padding: 6px 14px;
      border-radius: var(--radius-md);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid var(--clr-border);
      background: none;
      color: var(--clr-text-muted);
      font-family: var(--font-body);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all var(--t-fast);
    }
    .btn-refresh:hover { color: var(--clr-text); border-color: var(--clr-text-muted); }

    /* Message cards */
    .messages-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .message-card {
      background: var(--clr-surface);
      border: 1px solid var(--clr-border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      transition: border-color var(--t-fast);
    }
    .message-card.unread {
      border-color: rgba(76,175,128,0.3);
    }
    .message-card:hover { border-color: rgba(76,175,128,0.4); }

    .message-card__header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 18px 20px;
      cursor: pointer;
      user-select: none;
    }
    .message-card__avatar {
      width: 40px; height: 40px;
      border-radius: 50%;
      background: rgba(76,175,128,0.12);
      border: 1px solid rgba(76,175,128,0.2);
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem;
      font-weight: 700;
      color: var(--clr-success);
      flex-shrink: 0;
      font-family: var(--font-display);
    }
    .message-card__meta { flex: 1; min-width: 0; }
    .message-card__name {
      font-weight: 600;
      font-size: 0.92rem;
      color: var(--clr-text);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .message-card__email {
      font-size: 0.78rem;
      color: var(--clr-text-muted);
      margin-top: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .message-card__right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      flex-shrink: 0;
    }
    .message-card__time {
      font-size: 0.75rem;
      color: var(--clr-text-faint);
      white-space: nowrap;
    }
    .message-card__chevron {
      color: var(--clr-text-faint);
      font-size: 0.85rem;
      transition: transform var(--t-fast);
    }
    .message-card.expanded .message-card__chevron {
      transform: rotate(180deg);
    }

    /* Status badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 100px;
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .status-badge.unread  { background: rgba(200,80,80,0.12);  color: #e05c5c; }
    .status-badge.read    { background: rgba(91,141,238,0.12); color: #5b8dee; }
    .status-badge.resolved{ background: rgba(76,175,128,0.12); color: var(--clr-success); }

    /* Subject tag */
    .subject-tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 100px;
      font-size: 0.68rem;
      font-weight: 600;
      background: rgba(76,175,128,0.08);
      border: 1px solid rgba(76,175,128,0.18);
      color: var(--clr-success);
    }

    /* Expanded body */
    .message-card__body {
      display: none;
      padding: 0 20px 20px;
      border-top: 1px solid var(--clr-border);
      padding-top: 18px;
    }
    .message-card.expanded .message-card__body { display: block; }

    .message-card__subject-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    .message-card__subject-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--clr-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .message-card__text {
      font-size: 0.9rem;
      color: var(--clr-text-muted);
      line-height: 1.75;
      white-space: pre-wrap;
      word-break: break-word;
      background: var(--clr-surface-2);
      border: 1px solid var(--clr-border);
      border-radius: var(--radius-md);
      padding: 16px 18px;
      margin-bottom: 16px;
    }

    .message-card__actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .msg-btn {
      padding: 7px 14px;
      border-radius: var(--radius-md);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid var(--clr-border);
      background: none;
      color: var(--clr-text-muted);
      font-family: var(--font-body);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all var(--t-fast);
    }
    .msg-btn:hover { border-color: var(--clr-success); color: var(--clr-success); }
    .msg-btn.danger:hover { border-color: #e05c5c; color: #e05c5c; }
    .msg-btn.resolve {
      background: rgba(76,175,128,0.1);
      border-color: rgba(76,175,128,0.3);
      color: var(--clr-success);
    }

    /* Empty / loading states */
    .messages-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--clr-text-muted);
    }
    .messages-empty i { font-size: 2.5rem; opacity: 0.3; display: block; margin-bottom: 14px; }
    .messages-empty p { font-size: 0.9rem; }

    /* Stats strip */
    .messages-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    @media (max-width: 500px) {
      .messages-stats { grid-template-columns: 1fr; }
    }
    .stat-chip {
      background: var(--clr-surface);
      border: 1px solid var(--clr-border);
      border-radius: var(--radius-lg);
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .stat-chip__num {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--clr-text);
      font-family: var(--font-display);
      line-height: 1;
    }
    .stat-chip__label {
      font-size: 0.75rem;
      color: var(--clr-text-muted);
      margin-top: 3px;
    }
    .stat-chip__icon {
      width: 36px; height: 36px;
      border-radius: var(--radius-md);
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }
    .stat-chip__icon.red      { background: rgba(200,80,80,0.12);  color: #e05c5c; }
    .stat-chip__icon.blue     { background: rgba(91,141,238,0.12); color: #5b8dee; }
    .stat-chip__icon.green    { background: rgba(76,175,128,0.12); color: var(--clr-success); }
  </style>
</head>
<body data-page="admin">

  <!-- â”€â”€ Navigation â”€â”€ -->
  <header class="navbar" role="banner">
    <div class="container navbar__inner">
      <a href="index.html" class="navbar__logo" aria-label="PDFLibrary home">
        <div class="navbar__logo-icon" aria-hidden="true">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
          </svg>
        </div>
        Syntax Archives
      </a>
      <nav class="navbar__menu" role="navigation" aria-label="Primary navigation">
        <a href="index.html"   class="navbar__link">Home</a>
        <a href="library.html" class="navbar__link">Library</a>
        <a href="premium.html" class="navbar__link">Premium</a>
        <a href="admin.html"   class="navbar__link active">Admin</a>
      </nav>
      <div class="navbar__actions">
        <button class="btn btn-ghost btn-sm" id="nav-logout" style="display:none" onclick="Auth.logout('index.html')">Logout</button>
      </div>
      <button class="navbar__burger" aria-label="Toggle menu">
        <span></span><span></span><span></span>
      </button>
    </div>
  </header>

  <nav class="navbar__mobile" aria-label="Mobile navigation">
    <a href="index.html"   class="navbar__link">Home</a>
    <a href="library.html" class="navbar__link">Library</a>
    <a href="premium.html" class="navbar__link">Premium</a>
    <a href="admin.html"   class="navbar__link active">Admin</a>
  </nav>

  <!-- Toast -->
  <div class="admin-toast" id="admin-toast"></div>

  <main>

    <!-- ACCESS DENIED -->
    <div id="access-denied" style="display:none;">
      <div class="admin-access-denied">
        <div style="font-size:3rem;">ğŸ”’</div>
        <h2>Access Denied</h2>
        <p>This page is restricted to administrators only.</p>
        <a href="premium.html" class="btn btn-primary">Go to Premium Login</a>
      </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" style="display:none;">
      <div class="admin-wrapper">

        <!-- Header -->
        <div style="margin-bottom:32px;">
          <span class="section-label">Admin Console</span>
          <h1 style="font-size:2rem; margin-top:8px;">Dashboard</h1>
          <p style="margin-top:6px; color:var(--clr-text-muted);">Manage users and view contact messages.</p>
        </div>

        <!-- Tab Nav -->
        <div class="admin-tabs" role="tablist">
          <button class="admin-tab active" role="tab" data-tab="users" aria-selected="true">
            <i class="bi bi-people-fill"></i> Users
            <span class="tab-badge" id="tab-badge-users">0</span>
          </button>
          <button class="admin-tab" role="tab" data-tab="messages" aria-selected="false">
            <i class="bi bi-envelope-fill"></i> Messages
            <span class="tab-badge" id="tab-badge-messages">0</span>
          </button>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             TAB: USERS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="tab-panel active" id="panel-users">

          <!-- Users toolbar -->
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:8px;">
            <span style="font-size:0.78rem;color:var(--clr-text-faint);" id="users-last-updated"></span>
            <button class="btn-refresh" id="btn-refresh-users" style="padding:6px 14px;border-radius:6px;font-size:0.8rem;font-weight:600;cursor:pointer;border:1px solid var(--clr-border);background:none;color:var(--clr-text-muted);font-family:var(--font-body);display:inline-flex;align-items:center;gap:6px;">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
          </div>

          <!-- Pending Requests -->
          <h2 class="admin-section-title">
            â³ Pending Requests
            <span class="admin-badge admin-badge--pending" id="pending-count">0</span>
          </h2>

          <div class="admin-table-wrap">
            <table class="admin-table" aria-label="Pending subscription requests">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Txn ID</th>
                  <th>Requested</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="pending-tbody">
                <tr class="empty-row"><td colspan="6">No pending requests.</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Verified Users -->
          <h2 class="admin-section-title">
            âœ“ Verified Premium Users
            <span class="admin-badge admin-badge--verified" id="verified-count">0</span>
          </h2>

          <div class="admin-table-wrap">
            <table class="admin-table" aria-label="Verified premium users">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Username</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="verified-tbody">
                <tr class="empty-row"><td colspan="5">No users found.</td></tr>
              </tbody>
            </table>
          </div>

        </div><!-- /panel-users -->

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             TAB: MESSAGES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="tab-panel" id="panel-messages">

          <!-- Stats -->
          <div class="messages-stats">
            <div class="stat-chip">
              <div class="stat-chip__icon red"><i class="bi bi-envelope-fill"></i></div>
              <div>
                <div class="stat-chip__num" id="stat-unread">0</div>
                <div class="stat-chip__label">Unread</div>
              </div>
            </div>
            <div class="stat-chip">
              <div class="stat-chip__icon blue"><i class="bi bi-envelope-open-fill"></i></div>
              <div>
                <div class="stat-chip__num" id="stat-read">0</div>
                <div class="stat-chip__label">Read</div>
              </div>
            </div>
            <div class="stat-chip">
              <div class="stat-chip__icon green"><i class="bi bi-check-circle-fill"></i></div>
              <div>
                <div class="stat-chip__num" id="stat-resolved">0</div>
                <div class="stat-chip__label">Resolved</div>
              </div>
            </div>
          </div>

          <!-- Toolbar -->
          <div class="messages-toolbar">
            <div class="messages-filters">
              <button class="filter-btn active" data-filter="all">All</button>
              <button class="filter-btn" data-filter="unread">Unread</button>
              <button class="filter-btn" data-filter="read">Read</button>
              <button class="filter-btn" data-filter="resolved">Resolved</button>
            </div>
            <button class="btn-refresh" id="btn-refresh-messages">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
          </div>

          <!-- Message list -->
          <div class="messages-list" id="messages-list">
            <div class="messages-empty">
              <i class="bi bi-envelope"></i>
              <p>Loading messagesâ€¦</p>
            </div>
          </div>

        </div><!-- /panel-messages -->

      </div><!-- /admin-wrapper -->
    </div><!-- /admin-panel -->

  </main>

  <footer class="footer">
    <div class="container">
      <div class="footer__bottom">
        <span>Â© 2026 Syntax Archives. Admin Panel.</span>
      </div>
    </div>
  </footer>

  <script src="assets/js/main.js" defer></script>
  <script src="assets/js/auth.js" defer></script>

  <script>
  'use strict';

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HELPERS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function showToast(msg, type = 'success') {
    const t = document.getElementById('admin-toast');
    t.textContent = msg;
    t.className   = `admin-toast ${type} show`;
    setTimeout(() => t.classList.remove('show'), 3000);
  }

  function fmtDate(val) {
    if (!val) return 'â€”';
    const d = val.toDate ? val.toDate() : new Date(val);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
  }

  function fmtDateShort(val) {
    if (!val) return 'â€”';
    const d = val.toDate ? val.toDate() : new Date(val);
    const now = new Date();
    const diff = (now - d) / 1000;
    if (diff < 60)   return 'Just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  function escHtml(str) {
    return String(str)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function initials(name) {
    const parts = String(name).trim().split(' ');
    return (parts[0][0] + (parts[1] ? parts[1][0] : '')).toUpperCase();
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TABS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  document.querySelectorAll('.admin-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.admin-tab').forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-selected', 'false');
      });
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      btn.setAttribute('aria-selected', 'true');
      document.getElementById('panel-' + btn.dataset.tab).classList.add('active');
    });
  });

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     USERS TAB
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function renderPending() {
    const tbody = document.getElementById('pending-tbody');
    tbody.innerHTML = '<tr class="empty-row"><td colspan="6">Loadingâ€¦</td></tr>';
    const pending = await window.Store.getPending();
    document.getElementById('pending-count').textContent = pending.length;
    const usersBadge = document.getElementById('tab-badge-users');
    usersBadge.textContent = pending.length;
    usersBadge.classList.toggle('has-unread', pending.length > 0);

    if (!pending.length) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="6">No pending requests â€” all clear!</td></tr>';
      return;
    }
    tbody.innerHTML = pending.map(u => `
      <tr>
        <td><strong>${escHtml(u.name)}</strong></td>
        <td><code style="font-size:0.85em;background:var(--clr-surface-2);padding:2px 6px;border-radius:4px;">${escHtml(u.username)}</code></td>
        <td>${escHtml(u.email)}</td>
        <td>${escHtml(u.txnId || 'â€”')}</td>
        <td>${fmtDate(u.requestedAt)}</td>
        <td>
          <div class="admin-actions">
            <button class="btn-approve" onclick="approveUser('${escHtml(u.username)}')">âœ“ Approve</button>
            <button class="btn-reject"  onclick="rejectUser('${escHtml(u.username)}')">âœ• Reject</button>
          </div>
        </td>
      </tr>
    `).join('');
  }

  async function renderVerified() {
    const tbody   = document.getElementById('verified-tbody');
    tbody.innerHTML = '<tr class="empty-row"><td colspan="5">Loadingâ€¦</td></tr>';
    const users   = await window.Store.getUsers();
    const session = window.Auth.getSession();
    document.getElementById('verified-count').textContent = users.filter(u => u.role !== 'admin').length;

    if (!users.length) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="5">No verified users.</td></tr>';
      return;
    }
    tbody.innerHTML = users.map(u => {
      const isMe = u.username === session?.username && u.role === 'admin';
      const roleLabel = u.role === 'admin'
        ? '<span class="admin-badge admin-badge--count">Admin</span>'
        : '<span class="admin-badge admin-badge--verified">Premium</span>';
      const actions = isMe
        ? '<span style="color:var(--clr-text-faint);font-size:0.8rem;">Current session</span>'
        : u.role === 'admin'
          ? '<span style="color:var(--clr-text-faint);font-size:0.8rem;">Protected</span>'
          : `<button class="btn-revoke" onclick="revokeUser('${escHtml(u.username)}')">Revoke Access</button>`;
      return `
        <tr>
          <td><strong>${escHtml(u.name || u.username)}</strong></td>
          <td><code style="font-size:0.85em;background:var(--clr-surface-2);padding:2px 6px;border-radius:4px;">${escHtml(u.username)}</code></td>
          <td>${roleLabel}</td>
          <td><span style="color:var(--clr-success);font-size:0.82rem;">â— Verified</span></td>
          <td>${actions}</td>
        </tr>`;
    }).join('');
  }

  async function approveUser(username) {
    const ok = await window.Store.approvePending(username);
    if (ok) { showToast(`âœ“ ${username} approved.`, 'success'); renderPending(); renderVerified(); }
    else showToast('Could not approve user.', 'error');
  }
  async function rejectUser(username) {
    if (!confirm(`Reject request from "${username}"?`)) return;
    await window.Store.rejectPending(username);
    showToast(`Request from ${username} rejected.`, 'error');
    renderPending();
  }
  async function revokeUser(username) {
    if (!confirm(`Revoke premium access for "${username}"?`)) return;
    await window.Store.revokeUser(username);
    showToast(`Access revoked for ${username}.`, 'error');
    renderVerified();
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MESSAGES TAB
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  let allMessages  = [];
  let activeFilter = 'all';

  function getDB() {
    if (!firebase.apps.length) firebase.initializeApp(window.FIREBASE_CONFIG || FIREBASE_CONFIG);
    return firebase.firestore();
  }

  async function loadMessages() {
    const list = document.getElementById('messages-list');
    list.innerHTML = '<div class="messages-empty"><i class="bi bi-hourglass-split"></i><p>Loading messagesâ€¦</p></div>';
    try {
      const snap = await getDB()
        .collection('messages')
        .orderBy('submittedAt', 'desc')
        .get();
      allMessages = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      updateStats();
      renderMessages();
      updateTabBadge();
    } catch(e) {
      console.error(e);
      list.innerHTML = '<div class="messages-empty"><i class="bi bi-exclamation-circle"></i><p>Failed to load messages. Check your Firebase rules.</p></div>';
    }
  }

  function updateStats() {
    document.getElementById('stat-unread').textContent   = allMessages.filter(m => m.status === 'unread').length;
    document.getElementById('stat-read').textContent     = allMessages.filter(m => m.status === 'read').length;
    document.getElementById('stat-resolved').textContent = allMessages.filter(m => m.status === 'resolved').length;
  }

  function updateTabBadge() {
    const unread = allMessages.filter(m => m.status === 'unread').length;
    const badge  = document.getElementById('tab-badge-messages');
    badge.textContent = unread > 0 ? unread : allMessages.length;
    badge.classList.toggle('has-unread', unread > 0);
  }

  function renderMessages() {
    const list     = document.getElementById('messages-list');
    const filtered = activeFilter === 'all'
      ? allMessages
      : allMessages.filter(m => m.status === activeFilter);

    if (!filtered.length) {
      const labels = { all:'No messages yet.', unread:'No unread messages.', read:'No read messages.', resolved:'No resolved messages.' };
      list.innerHTML = `<div class="messages-empty"><i class="bi bi-inbox"></i><p>${labels[activeFilter]}</p></div>`;
      return;
    }

    list.innerHTML = filtered.map(msg => `
      <div class="message-card ${msg.status === 'unread' ? 'unread' : ''}" id="msg-${msg.id}">
        <div class="message-card__header" onclick="toggleMessage('${msg.id}')">
          <div class="message-card__avatar">${initials(msg.fullName || msg.firstName || '?')}</div>
          <div class="message-card__meta">
            <div class="message-card__name">
              ${escHtml(msg.fullName || msg.firstName)}
              <span class="status-badge ${msg.status}">${msg.status}</span>
            </div>
            <div class="message-card__email">${escHtml(msg.email)}</div>
          </div>
          <div class="message-card__right">
            <span class="message-card__time">${fmtDateShort(msg.submittedAt)}</span>
            <i class="bi bi-chevron-down message-card__chevron"></i>
          </div>
        </div>
        <div class="message-card__body">
          <div class="message-card__subject-row">
            <span class="message-card__subject-label">Subject:</span>
            <span class="subject-tag">${escHtml(msg.subject)}</span>
            <span style="font-size:0.75rem;color:var(--clr-text-faint);margin-left:auto;">${fmtDate(msg.submittedAt)}</span>
          </div>
          <div class="message-card__text">${escHtml(msg.message)}</div>
          <div class="message-card__actions">
            ${msg.status !== 'resolved' ? `<button class="msg-btn resolve" onclick="updateMsgStatus('${msg.id}','resolved')"><i class="bi bi-check-circle"></i> Mark Resolved</button>` : ''}
            ${msg.status === 'unread' ? `<button class="msg-btn" onclick="updateMsgStatus('${msg.id}','read')"><i class="bi bi-envelope-open"></i> Mark Read</button>` : ''}
            ${msg.status === 'resolved' ? `<button class="msg-btn" onclick="updateMsgStatus('${msg.id}','unread')"><i class="bi bi-arrow-counterclockwise"></i> Reopen</button>` : ''}
            <a class="msg-btn" href="mailto:${escHtml(msg.email)}?subject=Re: ${encodeURIComponent(msg.subject)}" target="_blank"><i class="bi bi-reply"></i> Reply via Email</a>
            <button class="msg-btn danger" onclick="deleteMessage('${msg.id}')"><i class="bi bi-trash"></i> Delete</button>
          </div>
        </div>
      </div>
    `).join('');
  }

  function toggleMessage(id) {
    const card = document.getElementById('msg-' + id);
    if (!card) return;
    const wasExpanded = card.classList.contains('expanded');
    /* Collapse all */
    document.querySelectorAll('.message-card.expanded').forEach(c => c.classList.remove('expanded'));
    if (!wasExpanded) {
      card.classList.add('expanded');
      /* Auto-mark unread â†’ read when opened */
      const msg = allMessages.find(m => m.id === id);
      if (msg && msg.status === 'unread') {
        updateMsgStatus(id, 'read', true); /* silent = true */
      }
    }
  }

  async function updateMsgStatus(id, status, silent = false) {
    try {
      await getDB().collection('messages').doc(id).update({ status });
      const msg = allMessages.find(m => m.id === id);
      if (msg) msg.status = status;
      updateStats();
      updateTabBadge();
      renderMessages();
      /* Re-expand the card after re-render */
      const card = document.getElementById('msg-' + id);
      if (card) card.classList.add('expanded');
      if (!silent) showToast(`Message marked as ${status}.`, 'success');
    } catch(e) {
      showToast('Failed to update message status.', 'error');
    }
  }

  async function deleteMessage(id) {
    if (!confirm('Delete this message? This cannot be undone.')) return;
    try {
      await getDB().collection('messages').doc(id).delete();
      allMessages = allMessages.filter(m => m.id !== id);
      updateStats();
      updateTabBadge();
      renderMessages();
      showToast('Message deleted.', 'error');
    } catch(e) {
      showToast('Failed to delete message.', 'error');
    }
  }

  /* Filter buttons */
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      activeFilter = btn.dataset.filter;
      renderMessages();
    });
  });

  document.getElementById('btn-refresh-messages').addEventListener('click', loadMessages);

  document.getElementById('btn-refresh-users').addEventListener('click', () => {
    renderPending();
    renderVerified();
    const el = document.getElementById('users-last-updated');
    if (el) el.textContent = 'Refreshed at ' + new Date().toLocaleTimeString();
  });

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INIT
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  window.addEventListener('DOMContentLoaded', () => {
    // Poll until defer-loaded auth.js has set up window.Auth and window.Store
    let attempts = 0;

    async function tryInit() {
      attempts++;
      const authReady  = window.Auth  && typeof window.Auth.getSession === 'function';
      const storeReady = window.Store && typeof window.Store.getUsers  === 'function';

      if (!authReady || !storeReady) {
        if (attempts < 60) { setTimeout(tryInit, 100); return; } // wait up to 6s
        document.getElementById('access-denied').style.display = 'block';
        document.querySelector('#access-denied p').textContent =
          'Could not load authentication module. Please refresh the page.';
        return;
      }

      // Ensure default users are seeded
      try { await window.Store.init(); } catch(e) { console.warn('Store.init:', e.message); }

      const session = window.Auth.getSession();
      if (!session || session.role !== 'admin') {
        document.getElementById('access-denied').style.display = 'block';
        return;
      }

      document.getElementById('admin-panel').style.display = 'block';
      const navLogout = document.getElementById('nav-logout');
      if (navLogout) navLogout.style.display = 'inline-flex';

      // Load all data in parallel
      await Promise.all([renderPending(), renderVerified(), loadMessages()]);

      // Stamp last-updated time
      const el = document.getElementById('users-last-updated');
      if (el) el.textContent = 'Loaded at ' + new Date().toLocaleTimeString();
    }

    tryInit();
  });
  </script>

</body>
</html>